<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEO Crawler Pro — ai.tudordaniel.ro</title>
<style>
:root {
  --bg: #0f1117; --surface: #1a1d27; --surface2: #242836;
  --border: #2e3347; --text: #e4e6f0; --text2: #9499b3;
  --accent: #6c5ce7; --accent2: #a29bfe;
  --green: #00cec9; --red: #ff6b6b; --orange: #fdcb6e; --blue: #74b9ff;
  --critical: #ff6b6b; --warning: #fdcb6e; --info: #74b9ff;
  --radius: 12px; --radius-sm: 8px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
a { color: var(--accent2); text-decoration: none; }
a:hover { text-decoration: underline; }

.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 0; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
header .container { display: flex; align-items: center; justify-content: space-between; }
.logo { font-size: 20px; font-weight: 700; color: var(--accent2); display: flex; align-items: center; gap: 8px; }
.logo svg { width: 28px; height: 28px; }
nav { display: flex; gap: 8px; }
nav button { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); padding: 6px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all .2s; }
nav button:hover, nav button.active { background: var(--accent); color: #fff; border-color: var(--accent); }

.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
.card h3 { font-size: 15px; color: var(--text2); margin-bottom: 12px; text-transform: uppercase; letter-spacing: .5px; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; text-align: center; }
.stat-card .value { font-size: 28px; font-weight: 700; }
.stat-card .label { font-size: 12px; color: var(--text2); margin-top: 4px; }
.stat-card.critical .value { color: var(--critical); }
.stat-card.warning .value { color: var(--warning); }
.stat-card.info .value { color: var(--info); }
.stat-card.good .value { color: var(--green); }

.score-ring { width: 80px; height: 80px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; margin: 0 auto 8px; }
.score-good { background: rgba(0,206,201,.15); color: var(--green); border: 3px solid var(--green); }
.score-ok { background: rgba(253,203,110,.15); color: var(--orange); border: 3px solid var(--orange); }
.score-bad { background: rgba(255,107,107,.15); color: var(--red); border: 3px solid var(--red); }

.form-row { display: flex; gap: 10px; margin-bottom: 16px; }
.form-row input { flex: 1; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 10px 14px; border-radius: var(--radius-sm); font-size: 14px; }
.form-row input:focus { outline: none; border-color: var(--accent); }
.btn { background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: var(--radius-sm); cursor: pointer; font-size: 14px; font-weight: 600; transition: all .2s; }
.btn:hover { background: var(--accent2); }
.btn:disabled { opacity: .5; cursor: not-allowed; }
.btn-sm { padding: 4px 12px; font-size: 12px; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text2); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent2); }
.btn-danger { background: var(--red); }

.badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
.badge-critical { background: rgba(255,107,107,.15); color: var(--critical); }
.badge-warning { background: rgba(253,203,110,.15); color: var(--warning); }
.badge-info { background: rgba(116,185,255,.15); color: var(--info); }
.badge-good { background: rgba(0,206,201,.15); color: var(--green); }

table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { text-align: left; padding: 8px 12px; color: var(--text2); border-bottom: 1px solid var(--border); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
tr:hover { background: var(--surface2); }
.url-cell { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.table-scroll { overflow-x: auto; margin: 0 -20px; padding: 0 20px; }
.table-scroll table { min-width: 1800px; }
.table-scroll th, .table-scroll td { white-space: nowrap; padding: 6px 10px; font-size: 12px; }
.table-scroll th { position: sticky; top: 0; background: var(--surface); z-index: 1; }
.table-scroll .url-col { min-width: 280px; max-width: 280px; overflow: hidden; text-overflow: ellipsis; }
.table-scroll .num-col { text-align: center; min-width: 60px; }
.table-scroll .bool-col { text-align: center; min-width: 50px; }
.check-yes { color: var(--red); font-weight: 700; }
.check-no { color: var(--green); }
.check-ok { color: var(--green); font-weight: 700; }
.check-warn { color: var(--warning); font-weight: 700; }

.accordion { border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 8px; overflow: hidden; }
.accordion-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; cursor: pointer; background: var(--surface2); transition: background .2s; }
.accordion-header:hover { background: var(--surface); }
.accordion-header .left { display: flex; align-items: center; gap: 10px; }
.accordion-body { padding: 0; max-height: 0; overflow: hidden; transition: max-height .3s, padding .3s; }
.accordion-body.open { padding: 12px 16px; max-height: 2000px; }
.chevron { transition: transform .2s; font-size: 12px; color: var(--text2); }
.chevron.open { transform: rotate(90deg); }

.spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 40px auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.pulse { animation: pulse 2s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }

.empty { text-align: center; padding: 40px; color: var(--text2); }

.issue-cat { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
.issue-cat-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; transition: all .2s; }
.issue-cat-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.issue-cat-card .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.issue-cat-card .title { font-size: 13px; font-weight: 600; }
.issue-cat-card .desc { font-size: 12px; color: var(--text2); }

.sitemap-list { display: flex; flex-direction: column; gap: 8px; }
.sitemap-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--surface2); border-radius: var(--radius-sm); font-size: 13px; }
.sitemap-item .url { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 12px; }
.sitemap-item .meta { display: flex; gap: 8px; align-items: center; color: var(--text2); font-size: 11px; }

@media (max-width: 768px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .form-row { flex-direction: column; }
  .issue-cat { grid-template-columns: 1fr; }
}

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      SEO Crawler Pro
    </div>
    <nav id="nav"></nav>
  </div>
</header>

<div class="container" id="app"></div>

<script>
const API = '/api';
let state = { view: 'home', projects: [], crawl: null, summary: null, pages: [], tablePages: [], pageDetail: null, pollTimer: null, tablePage: 0 };

async function api(path, opts = {}) {
  const res = await fetch(API + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
  if (!res.ok) throw new Error('API ' + res.status);
  return res.json();
}

function navigate(view, data, pushHistory) {
  if (state.pollTimer) { clearInterval(state.pollTimer); state.pollTimer = null; }
  if (data) Object.assign(state, data);
  state.view = view;
  if (pushHistory !== false) {
    history.pushState({ view: view }, '', '#' + view);
  }
  render();
}

window.addEventListener('popstate', function(e) {
  if (e.state && e.state.view) {
    state.view = e.state.view;
    render();
  } else {
    state.view = 'home';
    render();
  }
});

function render() {
  const app = document.getElementById('app');
  const nav = document.getElementById('nav');
  nav.innerHTML = '<button class="' + (state.view === 'home' ? 'active' : '') + '" onclick="navigate(\'home\')">Projects</button>';
  switch (state.view) {
    case 'home': renderHome(app); break;
    case 'crawling': renderCrawling(app); break;
    case 'dashboard': renderDashboard(app); break;
    case 'pages': renderPages(app); break;
    case 'detail': renderDetail(app); break;
  }
}

// ─── Home ────────────────────────────────────────────
async function renderHome(el) {
  el.innerHTML = '<div class="card"><h3>New Crawl</h3><div class="form-row"><input id="site-name" placeholder="Project name (e.g. My Website)"><input id="site-url" placeholder="https://example.com" value="https://"><button class="btn" onclick="startCrawl()">Crawl</button></div></div><div class="card"><h3>Recent Projects</h3><div id="projects-list"><div class="spinner"></div></div></div>';
  try {
    const projects = await api('/projects');
    const list = document.getElementById('projects-list');
    if (!projects.length) { list.innerHTML = '<div class="empty">No projects yet. Start your first crawl above.</div>'; return; }
    list.innerHTML = '<table><thead><tr><th>Name</th><th>URL</th><th>Created</th><th></th></tr></thead><tbody>' +
      projects.map(function(p) { return '<tr><td><strong>' + esc(p.name) + '</strong></td><td class="url-cell">' + esc(p.url) + '</td><td>' + new Date(p.created_at).toLocaleDateString() + '</td><td><button class="btn btn-sm" onclick="viewProject(' + p.id + ')">Crawls</button> <button class="btn btn-sm btn-outline" onclick="recrawl(' + p.id + ')">Re-crawl</button> <button class="btn btn-sm btn-danger" onclick="deleteProject(' + p.id + ')">Delete</button></td></tr>'; }).join('') +
      '</tbody></table>';
  } catch (e) { document.getElementById('projects-list').innerHTML = '<div class="empty">Error loading projects</div>'; }
}

async function startCrawl() {
  var name = document.getElementById('site-name').value.trim();
  var url = document.getElementById('site-url').value.trim();
  if (!name || !url || url === 'https://') return alert('Enter project name and URL');
  try {
    var project = await api('/projects', { method: 'POST', body: JSON.stringify({ name: name, url: url }) });
    var crawl = await api('/crawls', { method: 'POST', body: JSON.stringify({ project_id: project.id }) });
    navigate('crawling', { crawl: crawl });
    pollCrawl(crawl.id);
  } catch (e) { alert('Error: ' + e.message); }
}

async function recrawl(projectId) {
  try {
    var crawl = await api('/crawls', { method: 'POST', body: JSON.stringify({ project_id: projectId }) });
    navigate('crawling', { crawl: crawl });
    pollCrawl(crawl.id);
  } catch (e) { alert('Error: ' + e.message); }
}

async function viewProject(projectId) {
  try {
    var crawls = await api('/projects/' + projectId + '/crawls');
    if (crawls.length === 0) return alert('No crawls yet');
    var latest = crawls[0];
    if (latest.status === 'completed') {
      var results = await Promise.all([api('/crawls/' + latest.id + '/summary'), api('/crawls/' + latest.id + '/pages'), api('/crawls/' + latest.id + '/pages/table')]);
      navigate('dashboard', { crawl: latest, summary: results[0], pages: results[1], tablePages: results[2] });
    } else if (latest.status === 'running' || latest.status === 'pending') {
      navigate('crawling', { crawl: latest });
      pollCrawl(latest.id);
    } else { alert('Last crawl failed. Try re-crawling.'); }
  } catch (e) { alert('Error: ' + e.message); }
}

async function deleteProject(id) {
  if (!confirm('Delete this project and all its crawls?')) return;
  await api('/projects/' + id, { method: 'DELETE' });
  navigate('home');
}

// ─── Crawling ────────────────────────────────────────
function renderCrawling(el) {
  var c = state.crawl;
  el.innerHTML = '<div class="card" style="text-align:center;padding:40px;"><div class="spinner"></div><h2 style="margin-top:20px" class="pulse">Crawling website...</h2><p style="color:var(--text2);margin-top:8px;">Status: <strong>' + c.status + '</strong></p><p style="color:var(--text2);">Pages crawled: <strong id="crawl-count">' + c.pages_crawled + '</strong></p></div>';
}

function pollCrawl(crawlId) {
  state.pollTimer = setInterval(async function() {
    try {
      var c = await api('/crawls/' + crawlId);
      state.crawl = c;
      var el = document.getElementById('crawl-count');
      if (el) el.textContent = c.pages_crawled;
      if (c.status === 'completed') {
        clearInterval(state.pollTimer); state.pollTimer = null;
        var results = await Promise.all([api('/crawls/' + c.id + '/summary'), api('/crawls/' + c.id + '/pages'), api('/crawls/' + c.id + '/pages/table')]);
        navigate('dashboard', { crawl: c, summary: results[0], pages: results[1], tablePages: results[2] });
      } else if (c.status === 'failed') {
        clearInterval(state.pollTimer); state.pollTimer = null;
        alert('Crawl failed.'); navigate('home');
      }
    } catch (e) { console.error(e); }
  }, 2000);
}

// ─── Dashboard ───────────────────────────────────────
function renderDashboard(el) {
  var s = state.summary;
  var scoreClass = s.avg_score >= 70 ? 'score-good' : s.avg_score >= 40 ? 'score-ok' : 'score-bad';
  var PER_PAGE = 50;
  var allTP = state.tablePages || [];
  var totalTablePages = Math.ceil(allTP.length / PER_PAGE) || 1;
  if (state.tablePage >= totalTablePages) state.tablePage = totalTablePages - 1;
  if (state.tablePage < 0) state.tablePage = 0;
  var pageSlice = allTP.slice(state.tablePage * PER_PAGE, (state.tablePage + 1) * PER_PAGE);

  var html = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;"><h2>Crawl Dashboard</h2><div style="display:flex;gap:8px;"><button class="btn btn-sm" onclick="exportPDF()">&#128196; Export PDF</button><button class="btn btn-sm btn-outline" onclick="navigate(\'pages\')">All Pages</button><button class="btn btn-sm btn-outline" onclick="navigate(\'home\')">Back</button></div></div>';

  // ── Scorecards ──
  html += '<div class="stats-grid">';
  html += '<div class="stat-card"><div class="score-ring ' + scoreClass + '">' + s.avg_score + '</div><div class="label">Avg Score</div></div>';
  html += '<div class="stat-card"><div class="value">' + s.total_pages + '</div><div class="label">Pages Crawled</div></div>';
  html += '<div class="stat-card critical"><div class="value">' + s.critical_issues + '</div><div class="label">Critical Issues</div></div>';
  html += '<div class="stat-card warning"><div class="value">' + s.warnings + '</div><div class="label">Warnings</div></div>';
  html += '<div class="stat-card info"><div class="value">' + (s.info_issues || 0) + '</div><div class="label">Info</div></div>';
  html += '<div class="stat-card"><div class="value">' + s.avg_response_time + 's</div><div class="label">Avg Response</div></div>';
  html += '</div>';

  // ── All URLs Table (paginated 50/page) ──
  html += '<div class="card" id="sec-all-urls"><h3>All URLs <span class="badge badge-info">' + allTP.length + ' pages</span></h3>';
  // Pagination controls top
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">';
  html += '<span style="font-size:13px;color:var(--text2);">Page ' + (state.tablePage + 1) + ' of ' + totalTablePages + ' (' + allTP.length + ' URLs)</span>';
  html += '<div style="display:flex;gap:6px;">';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(0)" ' + (state.tablePage === 0 ? 'disabled' : '') + '>&laquo; First</button>';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (state.tablePage - 1) + ')" ' + (state.tablePage === 0 ? 'disabled' : '') + '>&lsaquo; Prev</button>';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (state.tablePage + 1) + ')" ' + (state.tablePage >= totalTablePages - 1 ? 'disabled' : '') + '>Next &rsaquo;</button>';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (totalTablePages - 1) + ')" ' + (state.tablePage >= totalTablePages - 1 ? 'disabled' : '') + '>Last &raquo;</button>';
  html += '</div></div>';
  html += '<div class="table-scroll"><table><thead><tr>';
  html += '<th class="url-col">URL</th><th class="num-col">Status</th><th class="num-col">Score</th><th class="num-col">Title Len</th><th class="num-col">Meta Len</th>';
  html += '<th class="num-col">H1s</th><th class="num-col">H2s</th><th class="bool-col">Noindex</th><th class="bool-col">Nofollow</th>';
  html += '<th class="num-col">Images</th><th class="num-col">No Alt</th><th class="num-col">Empty Alt</th>';
  html += '<th class="num-col">Int Links</th><th class="num-col">Ext Links</th><th class="num-col">NF Links</th>';
  html += '<th class="num-col">Words</th><th class="num-col">Text%</th>';
  html += '<th class="bool-col">Schema</th><th class="bool-col">Hreflang</th><th class="bool-col">Viewport</th><th class="bool-col">Lazy</th><th class="bool-col">Placeh.</th>';
  html += '<th class="num-col">Time</th><th class="num-col">Issues</th>';
  html += '</tr></thead><tbody>';
  pageSlice.forEach(function(p) {
    var stc = statusBadge(p.status_code);
    var sc = (p.score || 0) >= 70 ? 'badge-good' : (p.score || 0) >= 40 ? 'badge-warning' : 'badge-critical';
    var tl = p.title_length || 0;
    var tlc = (tl >= 30 && tl <= 60) ? 'check-ok' : tl === 0 ? 'check-yes' : 'check-warn';
    var ml = p.meta_description_length || 0;
    var mlc = (ml >= 120 && ml <= 160) ? 'check-ok' : ml === 0 ? 'check-yes' : 'check-warn';
    var h1c = p.h1_count === 1 ? 'check-ok' : p.h1_count === 0 ? 'check-yes' : 'check-warn';
    var wc = (p.word_count || 0) >= 300 ? '' : 'check-warn';
    var rt = p.response_time ? p.response_time.toFixed(2) : '?';
    var rtc = p.response_time && p.response_time > 3 ? 'check-warn' : '';
    html += '<tr>';
    html += '<td class="url-col"><a href="#" onclick="loadPage(' + p.id + ');return false" title="' + esc(p.url) + '">' + esc(p.url) + '</a></td>';
    html += '<td class="num-col"><span class="badge ' + stc + '">' + (p.status_code || '?') + '</span></td>';
    html += '<td class="num-col"><span class="badge ' + sc + '">' + (p.score || '?') + '</span></td>';
    html += '<td class="num-col ' + tlc + '">' + tl + '</td>';
    html += '<td class="num-col ' + mlc + '">' + ml + '</td>';
    html += '<td class="num-col ' + h1c + '">' + (p.h1_count || 0) + '</td>';
    html += '<td class="num-col">' + (p.h2_count || 0) + '</td>';
    html += '<td class="bool-col">' + (p.is_noindex ? '<span class="check-yes">YES</span>' : '<span class="check-no">—</span>') + '</td>';
    html += '<td class="bool-col">' + (p.is_nofollow_meta ? '<span class="check-yes">YES</span>' : '<span class="check-no">—</span>') + '</td>';
    html += '<td class="num-col">' + (p.total_images || 0) + '</td>';
    html += '<td class="num-col">' + (p.images_without_alt ? '<span class="check-warn">' + p.images_without_alt + '</span>' : '0') + '</td>';
    html += '<td class="num-col">' + (p.images_with_empty_alt ? '<span class="check-warn">' + p.images_with_empty_alt + '</span>' : '0') + '</td>';
    html += '<td class="num-col">' + (p.internal_links || 0) + '</td>';
    html += '<td class="num-col">' + (p.external_links || 0) + '</td>';
    html += '<td class="num-col">' + (p.nofollow_links || 0) + '</td>';
    html += '<td class="num-col ' + wc + '">' + (p.word_count || 0) + '</td>';
    html += '<td class="num-col">' + (p.code_to_text_ratio != null ? p.code_to_text_ratio + '%' : '?') + '</td>';
    html += '<td class="bool-col">' + (p.has_schema_markup ? '<span class="check-ok">&#10003;</span>' : '<span class="check-warn">&#10007;</span>') + '</td>';
    html += '<td class="bool-col">' + (p.has_hreflang ? '<span class="check-ok">&#10003;</span>' : '—') + '</td>';
    html += '<td class="bool-col">' + (p.has_viewport_meta ? '<span class="check-ok">&#10003;</span>' : '<span class="check-yes">&#10007;</span>') + '</td>';
    html += '<td class="bool-col">' + (p.has_lazy_loading ? '<span class="check-ok">&#10003;</span>' : '—') + '</td>';
    html += '<td class="bool-col">' + (p.has_placeholders ? '<span class="check-yes">YES</span>' : '—') + '</td>';
    html += '<td class="num-col ' + rtc + '">' + rt + 's</td>';
    html += '<td class="num-col">' + (p.issues_count || 0) + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  // Pagination controls bottom
  html += '<div style="display:flex;align-items:center;justify-content:center;margin-top:10px;gap:6px;">';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (state.tablePage - 1) + ')" ' + (state.tablePage === 0 ? 'disabled' : '') + '>&lsaquo; Prev</button>';
  for (var pi = 0; pi < totalTablePages; pi++) {
    if (totalTablePages <= 10 || pi === 0 || pi === totalTablePages - 1 || Math.abs(pi - state.tablePage) <= 2) {
      html += '<button class="btn btn-sm ' + (pi === state.tablePage ? '' : 'btn-outline') + '" onclick="goTablePage(' + pi + ')" style="min-width:32px;">' + (pi + 1) + '</button>';
    } else if (pi === 1 || pi === totalTablePages - 2) {
      html += '<span style="color:var(--text2);padding:0 4px;">...</span>';
    }
  }
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (state.tablePage + 1) + ')" ' + (state.tablePage >= totalTablePages - 1 ? 'disabled' : '') + '>Next &rsaquo;</button>';
  html += '</div></div>';

  // ── Issue Sections (collapsed accordions with sentence summaries) ──
  html += '<div class="card"><h3>Issue Details</h3>';

  // Helper: build each issue section as a collapsed accordion
  function issueAccordion(id, sev, sentence, bodyFn) {
    html += '<div class="accordion" id="' + id + '"><div class="accordion-header" onclick="toggleAcc(this)"><div class="left"><span class="badge badge-' + sev + '">' + sev + '</span><span style="font-size:13px;">' + sentence + '</span></div><span class="chevron">&#9654;</span></div>';
    html += '<div class="accordion-body">';
    bodyFn();
    html += '</div></div>';
  }

  // Duplicate Titles
  if (s.duplicate_titles.length) {
    issueAccordion('sec-dup-titles', 'warning', s.duplicate_titles.length + ' groups of pages share the same title tag', function() {
      s.duplicate_titles.forEach(function(g) {
        html += '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:var(--text);">"' + esc(g.value.substring(0, 80)) + (g.value.length > 80 ? '...' : '') + '" (' + g.count + 'x)</strong><div style="margin-left:12px;">';
        g.pages.forEach(function(p) { html += '<div style="font-size:12px;"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></div>'; });
        html += '</div></div>';
      });
    });
  }

  // Duplicate Meta Descriptions
  if (s.duplicate_meta_descriptions.length) {
    issueAccordion('sec-dup-metas', 'warning', s.duplicate_meta_descriptions.length + ' groups of pages share the same meta description', function() {
      s.duplicate_meta_descriptions.forEach(function(g) {
        html += '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:var(--text);">"' + esc(g.value.substring(0, 80)) + (g.value.length > 80 ? '...' : '') + '" (' + g.count + 'x)</strong><div style="margin-left:12px;">';
        g.pages.forEach(function(p) { html += '<div style="font-size:12px;"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></div>'; });
        html += '</div></div>';
      });
    });
  }

  // Status Code Breakdown
  var statusSentence = (s.status_code_breakdown || []).map(function(c) { return c.count + ' pages returned HTTP ' + c.status_code; }).join(', ');
  if (statusSentence) {
    issueAccordion('sec-status', 'info', statusSentence, function() {
      html += '<div style="display:flex;gap:12px;flex-wrap:wrap;">';
      (s.status_code_breakdown || []).forEach(function(c) {
        var badge = statusBadge(c.status_code);
        var color = badge.replace('badge-', '');
        html += '<div class="stat-card ' + color + '" style="min-width:100px;flex:0;"><div class="value">' + c.count + '</div><div class="label">HTTP ' + c.status_code + '</div></div>';
      });
      html += '</div>';
    });
  }

  // Canonical Issues
  if (s.canonical_issues.length) {
    issueAccordion('sec-canonical', 'warning', s.canonical_issues.length + ' pages have canonical tag issues', function() {
      html += '<table><thead><tr><th>Page URL</th><th>Canonical URL</th><th>Issues</th></tr></thead><tbody>';
      s.canonical_issues.forEach(function(c) {
        html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + c.page_id + ');return false">' + esc(c.url) + '</a></td><td class="url-cell">' + esc(c.canonical_url || 'none') + '</td><td>' + (c.issues || []).map(function(i) { return '<span class="badge badge-warning">' + i + '</span> '; }).join('') + '</td></tr>';
      });
      html += '</tbody></table>';
    });
  }

  // Indexability
  if (s.noindex_pages.length || s.nofollow_pages.length) {
    var idxSentence = [];
    if (s.noindex_pages.length) idxSentence.push(s.noindex_pages.length + ' pages are set to noindex');
    if (s.nofollow_pages.length) idxSentence.push(s.nofollow_pages.length + ' pages have nofollow meta');
    issueAccordion('sec-indexability', 'warning', idxSentence.join('; '), function() {
      if (s.noindex_pages.length) {
        html += '<h4 style="margin:4px 0 6px;font-size:12px;color:var(--warning)">Noindex Pages</h4>';
        s.noindex_pages.forEach(function(p) { html += '<div style="font-size:12px;margin-bottom:2px;"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></div>'; });
      }
      if (s.nofollow_pages.length) {
        html += '<h4 style="margin:8px 0 6px;font-size:12px;color:var(--warning)">Nofollow Meta Pages</h4>';
        s.nofollow_pages.forEach(function(p) { html += '<div style="font-size:12px;margin-bottom:2px;"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></div>'; });
      }
    });
  }

  // Image Alt Text Issues
  if (s.pages_missing_alt.length || (s.pages_empty_alt && s.pages_empty_alt.length)) {
    var imgParts = [];
    if (s.pages_missing_alt.length) imgParts.push(s.total_images_missing_alt + ' images across ' + s.pages_missing_alt.length + ' pages are missing alt attributes');
    if (s.pages_empty_alt && s.pages_empty_alt.length) imgParts.push((s.total_images_empty_alt || 0) + ' images have empty alt text');
    issueAccordion('sec-images', 'warning', imgParts.join('; '), function() {
      if (s.pages_missing_alt.length) {
        html += '<h4 style="margin:4px 0 6px;font-size:12px;color:var(--warning)">Missing Alt Attribute</h4>';
        html += '<table><thead><tr><th>Page URL</th><th>Missing</th><th>Sample Image</th><th>Total</th></tr></thead><tbody>';
        s.pages_missing_alt.forEach(function(p) {
          var sampleImg = p.sample_image_url ? '<a href="' + esc(p.sample_image_url) + '" target="_blank" style="font-size:11px;word-break:break-all;">' + esc(p.sample_image_url.split('/').pop().substring(0, 40)) + '</a>' : '—';
          html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></td><td><span class="badge badge-warning">' + p.missing_count + '</span></td><td>' + sampleImg + '</td><td>' + p.total_images + '</td></tr>';
        });
        html += '</tbody></table>';
      }
      if (s.pages_empty_alt && s.pages_empty_alt.length) {
        html += '<h4 style="margin:8px 0 6px;font-size:12px;color:var(--warning)">Empty Alt Text</h4>';
        html += '<table><thead><tr><th>Page URL</th><th>Empty Alt</th><th>Sample Image</th><th>Total</th></tr></thead><tbody>';
        s.pages_empty_alt.forEach(function(p) {
          var sampleImg = p.sample_image_url ? '<a href="' + esc(p.sample_image_url) + '" target="_blank" style="font-size:11px;word-break:break-all;">' + esc(p.sample_image_url.split('/').pop().substring(0, 40)) + '</a>' : '—';
          html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></td><td><span class="badge badge-warning">' + p.empty_count + '</span></td><td>' + sampleImg + '</td><td>' + p.total_images + '</td></tr>';
        });
        html += '</tbody></table>';
      }
    });
  }

  // Hreflang Issues
  if (s.hreflang_issues.length) {
    issueAccordion('sec-hreflang', 'warning', s.hreflang_issues.length + ' pages have hreflang implementation issues', function() {
      html += '<table><thead><tr><th>Page URL</th><th>Issues</th></tr></thead><tbody>';
      s.hreflang_issues.forEach(function(h) {
        html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + h.page_id + ');return false">' + esc(h.url) + '</a></td><td>' + (h.issues || []).map(function(i) { return '<div style="font-size:12px;color:var(--warning)">' + esc(i) + '</div>'; }).join('') + '</td></tr>';
      });
      html += '</tbody></table>';
    });
  }

  // Content Issues
  if (s.thin_content_pages.length || s.low_text_ratio_pages.length || s.placeholder_pages.length) {
    var contentParts = [];
    if (s.thin_content_pages.length) contentParts.push(s.thin_content_pages.length + ' pages have thin content (<300 words)');
    if (s.low_text_ratio_pages.length) contentParts.push(s.low_text_ratio_pages.length + ' pages have low text-to-HTML ratio');
    if (s.placeholder_pages.length) contentParts.push(s.placeholder_pages.length + ' pages contain placeholder/lorem ipsum text');
    issueAccordion('sec-content', 'warning', contentParts.join('; '), function() {
      if (s.thin_content_pages.length) {
        html += '<h4 style="margin:4px 0 6px;font-size:12px;color:var(--warning)">Thin Content</h4>';
        html += '<table><thead><tr><th>URL</th><th>Word Count</th></tr></thead><tbody>';
        s.thin_content_pages.forEach(function(p) { html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></td><td><span class="badge badge-warning">' + p.word_count + ' words</span></td></tr>'; });
        html += '</tbody></table>';
      }
      if (s.low_text_ratio_pages.length) {
        html += '<h4 style="margin:8px 0 6px;font-size:12px;color:var(--warning)">Low Text-to-HTML Ratio</h4>';
        html += '<table><thead><tr><th>URL</th><th>Ratio</th></tr></thead><tbody>';
        s.low_text_ratio_pages.forEach(function(p) { html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></td><td><span class="badge badge-critical">' + p.ratio + '%</span></td></tr>'; });
        html += '</tbody></table>';
      }
      if (s.placeholder_pages.length) {
        html += '<h4 style="margin:8px 0 6px;font-size:12px;color:var(--critical)">Placeholder / Lorem Ipsum</h4>';
        html += '<table><thead><tr><th>URL</th><th>Found</th></tr></thead><tbody>';
        s.placeholder_pages.forEach(function(p) {
          html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></td><td>' + (p.content || []).slice(0, 3).map(function(c) { return '<code style="font-size:11px;background:var(--surface);padding:2px 6px;border-radius:4px;margin-right:4px">' + esc(c.match) + '</code>'; }).join('') + '</td></tr>';
        });
        html += '</tbody></table>';
      }
    });
  }

  // Missing Structure (title, meta, h1, viewport)
  var structParts = [];
  if (s.pages_missing_title) structParts.push(s.pages_missing_title + ' pages missing title');
  if (s.pages_missing_meta) structParts.push(s.pages_missing_meta + ' pages missing meta description');
  if (s.pages_missing_h1) structParts.push(s.pages_missing_h1 + ' pages missing H1');
  if (s.pages_missing_viewport) structParts.push(s.pages_missing_viewport + ' pages missing viewport');
  if (s.pages_without_schema) structParts.push(s.pages_without_schema + ' pages without schema markup');
  if (structParts.length) {
    issueAccordion('sec-structure', 'critical', structParts.join('; '), function() {
      html += '<table><thead><tr><th>Issue</th><th>Count</th></tr></thead><tbody>';
      if (s.pages_missing_title) html += '<tr><td>Missing Title</td><td><span class="badge badge-critical">' + s.pages_missing_title + '</span></td></tr>';
      if (s.pages_missing_meta) html += '<tr><td>Missing Meta Description</td><td><span class="badge badge-critical">' + s.pages_missing_meta + '</span></td></tr>';
      if (s.pages_missing_h1) html += '<tr><td>Missing H1</td><td><span class="badge badge-critical">' + s.pages_missing_h1 + '</span></td></tr>';
      if (s.pages_missing_viewport) html += '<tr><td>Missing Viewport</td><td><span class="badge badge-critical">' + s.pages_missing_viewport + '</span></td></tr>';
      if (s.pages_without_schema) html += '<tr><td>No Schema Markup</td><td><span class="badge badge-info">' + s.pages_without_schema + '</span></td></tr>';
      html += '</tbody></table>';
    });
  }

  // Slow Pages
  if (s.slow_pages.length) {
    issueAccordion('sec-slow', 'warning', s.slow_pages.length + ' pages take more than 3 seconds to respond', function() {
      html += '<table><thead><tr><th>URL</th><th>Response Time</th></tr></thead><tbody>';
      s.slow_pages.forEach(function(p) { html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></td><td><span class="badge badge-warning">' + p.response_time.toFixed(2) + 's</span></td></tr>'; });
      html += '</tbody></table>';
    });
  }

  // Robots & Sitemaps
  var robotsSentence = 'robots.txt ' + (s.robots_txt_status === 'found' ? 'found' : 'not found') + '; ' + ((s.sitemaps_found && s.sitemaps_found.length) ? s.sitemaps_found.length + ' sitemaps detected' : 'no sitemaps detected');
  issueAccordion('sec-robots', 'info', robotsSentence, function() {
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">';
    html += '<div><h4 style="margin-bottom:8px;font-size:12px;">robots.txt</h4><div class="sitemap-item"><span>Status</span><span class="badge ' + (s.robots_txt_status === 'found' ? 'badge-good' : 'badge-critical') + '">' + (s.robots_txt_status || 'unknown') + '</span></div></div>';
    html += '<div><h4 style="margin-bottom:8px;font-size:12px;">Sitemaps</h4><div class="sitemap-list">';
    if (s.sitemaps_found && s.sitemaps_found.length) {
      s.sitemaps_found.forEach(function(sm) {
        html += '<div class="sitemap-item"><span class="url">' + esc(sm.url) + '</span><span class="meta"><span class="badge badge-info">' + sm.type + '</span><span>' + (sm.urls_count || 0) + ' URLs</span></span></div>';
      });
    } else {
      html += '<div style="color:var(--text2);font-size:12px;">No sitemaps detected</div>';
    }
    html += '</div></div></div>';
  });

  // All Issues by Type
  if ((s.issue_groups || []).length) {
    (s.issue_groups || []).forEach(function(g) {
      html += '<div class="accordion"><div class="accordion-header" onclick="toggleAcc(this)"><div class="left"><span class="badge badge-' + g.severity + '">' + g.severity + '</span><span style="font-size:13px;">' + fmtType(g.category) + ' — ' + g.count + ' page' + (g.count > 1 ? 's' : '') + ' affected</span></div><span class="chevron">&#9654;</span></div>';
      html += '<div class="accordion-body"><table><thead><tr><th>URL</th><th>Detail</th></tr></thead><tbody>';
      g.pages.slice(0, 30).forEach(function(p) {
        html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></td><td style="font-size:12px;color:var(--text2)">' + esc(p.detail) + '</td></tr>';
      });
      if (g.count > 30) html += '<tr><td colspan="2" style="color:var(--text2);font-size:12px;">...and ' + (g.count - 30) + ' more</td></tr>';
      html += '</tbody></table></div></div>';
    });
  }

  html += '</div>'; // close Issue Details card

  el.innerHTML = html;
}

function goTablePage(pg) {
  var allTP = state.tablePages || [];
  var totalTablePages = Math.ceil(allTP.length / 50) || 1;
  if (pg < 0) pg = 0;
  if (pg >= totalTablePages) pg = totalTablePages - 1;
  state.tablePage = pg;
  render();
  var el = document.getElementById('sec-all-urls');
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderAccordionGroups(groups) {
  var html = '';
  groups.forEach(function(g) {
    html += '<div class="accordion"><div class="accordion-header" onclick="toggleAcc(this)"><div class="left"><span class="badge badge-warning">' + g.count + 'x</span><span style="font-size:13px;">' + esc(g.value.substring(0, 80)) + (g.value.length > 80 ? '...' : '') + '</span></div><span class="chevron">&#9654;</span></div>';
    html += '<div class="accordion-body"><table><thead><tr><th>URL</th></tr></thead><tbody>';
    g.pages.forEach(function(p) { html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></td></tr>'; });
    html += '</tbody></table></div></div>';
  });
  return html;
}

function toggleAcc(header) {
  var body = header.nextElementSibling;
  var chev = header.querySelector('.chevron');
  body.classList.toggle('open');
  chev.classList.toggle('open');
}

function fmtType(type) { return type.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); }); }

function scrollToSec(id) {
  var el = document.getElementById(id);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function statusBadge(code) {
  if (!code) return 'badge-critical';
  if (code >= 200 && code < 300) return 'badge-good';
  if (code === 301) return 'badge-info';      // permanent redirect — blue
  if (code === 302 || code === 307 || code === 308) return 'badge-warning';  // temp redirect — orange
  if (code === 404) return 'badge-critical';   // not found — red
  if (code === 403) return 'badge-warning';    // forbidden — orange
  if (code >= 400 && code < 500) return 'badge-warning';
  if (code >= 500) return 'badge-critical';    // server error — red
  return 'badge-info';
}

function exportPDF() {
  if (!state.crawl) return;
  var url = API + '/crawls/' + state.crawl.id + '/export/pdf';
  window.open(url, '_blank');
}

// ─── Pages List ──────────────────────────────────────
function renderPages(el) {
  var pages = state.pages;
  var html = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;"><h2>All Pages (' + pages.length + ')</h2><button class="btn btn-sm btn-outline" onclick="navigate(\'dashboard\')">Back to Dashboard</button></div>';
  html += '<div class="card"><table><thead><tr><th>URL</th><th>Status</th><th>Score</th><th>Issues</th><th>Response</th><th></th></tr></thead><tbody>';
  pages.forEach(function(p) {
    var sc = (p.score || 0) >= 70 ? 'badge-good' : (p.score || 0) >= 40 ? 'badge-warning' : 'badge-critical';
    var stc = (p.status_code || 0) < 300 ? 'badge-good' : (p.status_code || 0) < 400 ? 'badge-info' : 'badge-critical';
    html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.id + ');return false">' + esc(p.url) + '</a></td><td><span class="badge ' + stc + '">' + (p.status_code || '?') + '</span></td><td><span class="badge ' + sc + '">' + (p.score || '?') + '</span></td><td>' + p.issues_count + '</td><td>' + (p.response_time ? p.response_time.toFixed(2) + 's' : '?') + '</td><td><button class="btn btn-sm btn-outline" onclick="loadPage(' + p.id + ')">Details</button></td></tr>';
  });
  html += '</tbody></table></div>';
  el.innerHTML = html;
}

// ─── Page Detail ─────────────────────────────────────
async function loadPage(pageId) {
  try {
    var page = await api('/pages/' + pageId);
    navigate('detail', { pageDetail: page });
  } catch (e) { alert('Error: ' + e.message); }
}

function renderDetail(el) {
  var p = state.pageDetail;
  if (!p) return;
  var sc = (p.score || 0) >= 70 ? 'score-good' : (p.score || 0) >= 40 ? 'score-ok' : 'score-bad';
  var html = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;"><h2 style="font-size:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;">' + esc(p.url) + '</h2><button class="btn btn-sm btn-outline" onclick="history.back()">Back</button></div>';

  html += '<div class="stats-grid">';
  html += '<div class="stat-card"><div class="score-ring ' + sc + '">' + (p.score || '?') + '</div><div class="label">Score</div></div>';
  html += '<div class="stat-card"><div class="value">' + (p.status_code || '?') + '</div><div class="label">Status</div></div>';
  html += '<div class="stat-card"><div class="value">' + (p.response_time ? p.response_time.toFixed(2) + 's' : '?') + '</div><div class="label">Response</div></div>';
  html += '<div class="stat-card"><div class="value">' + (p.word_count || 0) + '</div><div class="label">Words</div></div>';
  html += '<div class="stat-card"><div class="value">' + (p.code_to_text_ratio != null ? p.code_to_text_ratio + '%' : '?') + '</div><div class="label">Text/HTML</div></div>';
  html += '</div>';

  // Issues
  html += '<div class="card"><h3>Issues (' + (p.issues || []).length + ')</h3>';
  if ((p.issues || []).length) {
    html += '<table><thead><tr><th>Severity</th><th>Type</th><th>Message</th></tr></thead><tbody>';
    (p.issues || []).forEach(function(i) { html += '<tr><td><span class="badge badge-' + i.severity + '">' + i.severity + '</span></td><td style="font-size:12px;">' + fmtType(i.type) + '</td><td style="font-size:12px;">' + esc(i.message) + '</td></tr>'; });
    html += '</tbody></table>';
  } else { html += '<div style="color:var(--green);padding:12px;">No issues found!</div>'; }
  html += '</div>';

  // SEO Details
  html += '<div class="card"><h3>On-Page SEO</h3><table><tbody>';
  html += dRow('Title', p.title, p.title_length ? '(' + p.title_length + ' chars)' : '');
  html += dRow('Meta Description', p.meta_description ? p.meta_description.substring(0, 120) + '...' : null, p.meta_description_length ? '(' + p.meta_description_length + ' chars)' : '');
  html += dRow('Canonical URL', p.canonical_url);
  if (p.canonical_issues && p.canonical_issues.length) html += dRow('Canonical Issues', p.canonical_issues.join(', '));
  html += dRow('Robots Meta', p.robots_meta);
  html += dRow('Noindex', p.is_noindex ? 'Yes' : 'No');
  html += dRow('Nofollow Meta', p.is_nofollow_meta ? 'Yes' : 'No');
  html += dRow('H1', p.h1_texts ? p.h1_texts.join(', ') : 'None', '(' + p.h1_count + ' found)');
  html += dRow('H2-H6', 'H2:' + p.h2_count + ' H3:' + p.h3_count + ' H4:' + (p.h4_count || 0) + ' H5:' + (p.h5_count || 0) + ' H6:' + (p.h6_count || 0));
  html += dRow('Viewport', p.has_viewport_meta ? 'Present' : 'Missing');
  html += '</tbody></table></div>';

  // Links & Images
  html += '<div class="card"><h3>Links & Images</h3><table><tbody>';
  html += dRow('Internal Links', p.internal_links);
  html += dRow('External Links', p.external_links);
  html += dRow('Nofollow Links', p.nofollow_links || 0);
  html += dRow('Total Images', p.total_images);
  html += dRow('Images Without Alt', p.images_without_alt);
  html += dRow('Images Empty Alt', p.images_with_empty_alt || 0);
  html += '</tbody></table></div>';

  // Structured Data & Social
  html += '<div class="card"><h3>Structured Data & Social</h3><table><tbody>';
  html += dRow('Schema Markup', p.has_schema_markup ? 'Yes' : 'No');
  html += dRow('Schema Types', p.schema_types ? p.schema_types.join(', ') : 'None');
  html += dRow('OG Title', p.og_title);
  html += dRow('OG Description', p.og_description ? p.og_description.substring(0, 100) + '...' : null);
  html += dRow('OG Image', p.og_image);
  html += dRow('Hreflang', p.has_hreflang ? 'Yes (' + (p.hreflang_entries || []).length + ' entries)' : 'No');
  html += dRow('Placeholders', p.has_placeholders ? 'Yes (' + (p.placeholder_content || []).length + ')' : 'No');
  html += dRow('Lazy Loading', p.has_lazy_loading ? 'Yes' : 'No');
  html += '</tbody></table></div>';

  el.innerHTML = html;
}

function dRow(label, value, extra) {
  var display = value || '<span style="color:var(--text2)">—</span>';
  return '<tr><td style="color:var(--text2);width:200px;font-size:13px;">' + label + '</td><td style="font-size:13px;">' + esc(String(display)) + ' <span style="color:var(--text2);font-size:11px;">' + (extra || '') + '</span></td></tr>';
}

function esc(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

history.replaceState({ view: 'home' }, '', '#home');
render();
</script>
</body>
</html>
