<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SEO Crawler Pro ‚Äî ai.tudordaniel.ro</title>
<style>
:root {
  --bg: #0f1117; --surface: #1a1d27; --surface2: #242836;
  --border: #2e3347; --text: #e4e6f0; --text2: #9499b3;
  --accent: #6c5ce7; --accent2: #a29bfe;
  --green: #00cec9; --red: #ff6b6b; --orange: #fdcb6e; --blue: #74b9ff;
  --critical: #ff6b6b; --warning: #fdcb6e; --info: #74b9ff;
  --radius: 12px; --radius-sm: 8px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; }
a { color: var(--accent2); text-decoration: none; }
a:hover { text-decoration: underline; }

.container { max-width: 1200px; margin: 0 auto; padding: 20px; }
header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 16px 0; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(10px); }
header .container { display: flex; align-items: center; justify-content: space-between; }
.logo { font-size: 20px; font-weight: 700; color: var(--accent2); display: flex; align-items: center; gap: 8px; }
.logo svg { width: 28px; height: 28px; }
nav { display: flex; gap: 8px; }
nav button { background: var(--surface2); color: var(--text2); border: 1px solid var(--border); padding: 6px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; transition: all .2s; }
nav button:hover, nav button.active { background: var(--accent); color: #fff; border-color: var(--accent); }

.card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
.card h3 { font-size: 15px; color: var(--text2); margin-bottom: 12px; text-transform: uppercase; letter-spacing: .5px; }

.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; text-align: center; }
.stat-card .value { font-size: 28px; font-weight: 700; }
.stat-card .label { font-size: 12px; color: var(--text2); margin-top: 4px; }
.stat-card.critical .value { color: var(--critical); }
.stat-card.warning .value { color: var(--warning); }
.stat-card.info .value { color: var(--info); }
.stat-card.good .value { color: var(--green); }

.score-ring { width: 80px; height: 80px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 700; margin: 0 auto 8px; }
.score-good { background: rgba(0,206,201,.15); color: var(--green); border: 3px solid var(--green); }
.score-ok { background: rgba(253,203,110,.15); color: var(--orange); border: 3px solid var(--orange); }
.score-bad { background: rgba(255,107,107,.15); color: var(--red); border: 3px solid var(--red); }

.form-row { display: flex; gap: 10px; margin-bottom: 16px; }
.form-row input { flex: 1; background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 10px 14px; border-radius: var(--radius-sm); font-size: 14px; }
.form-row input:focus { outline: none; border-color: var(--accent); }
.btn { background: var(--accent); color: #fff; border: none; padding: 10px 20px; border-radius: var(--radius-sm); cursor: pointer; font-size: 14px; font-weight: 600; transition: all .2s; }
.btn:hover { background: var(--accent2); }
.btn:disabled { opacity: .5; cursor: not-allowed; }
.btn-sm { padding: 4px 12px; font-size: 12px; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text2); }
.btn-outline:hover { border-color: var(--accent); color: var(--accent2); }
.btn-danger { background: var(--red); }

.badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
.badge-critical { background: rgba(255,107,107,.15); color: var(--critical); }
.badge-warning { background: rgba(253,203,110,.15); color: var(--warning); }
.badge-info { background: rgba(116,185,255,.15); color: var(--info); }
.badge-good { background: rgba(0,206,201,.15); color: var(--green); }
.badge-2xx { background: rgba(0,206,201,.15); color: #00cec9; }
.badge-3xx { background: rgba(162,155,254,.18); color: #a29bfe; }
.badge-4xx { background: rgba(253,203,110,.18); color: #fdcb6e; }
.badge-5xx { background: rgba(255,107,107,.15); color: #ff6b6b; }
[data-theme="light"] .badge-2xx { background: rgba(0,168,157,.1); color: #00856e; }
[data-theme="light"] .badge-3xx { background: rgba(108,92,231,.12); color: #6c5ce7; }
[data-theme="light"] .badge-4xx { background: rgba(230,126,34,.12); color: #d35400; }
[data-theme="light"] .badge-5xx { background: rgba(231,76,60,.12); color: #c0392b; }

table { width: 100%; border-collapse: collapse; font-size: 13px; }
th { text-align: left; padding: 8px 12px; color: var(--text2); border-bottom: 1px solid var(--border); font-size: 11px; text-transform: uppercase; letter-spacing: .5px; }
td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
tr:hover { background: var(--surface2); }
.url-cell { max-width: 400px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

.table-scroll { overflow-x: auto; margin: 0 -20px; padding: 0 20px; }
.table-scroll table { min-width: 1800px; }
.table-scroll th, .table-scroll td { white-space: nowrap; padding: 6px 10px; font-size: 12px; }
.table-scroll th { position: sticky; top: 0; background: var(--surface); z-index: 1; }
.table-scroll .url-col { min-width: 280px; max-width: 280px; overflow: hidden; text-overflow: ellipsis; }
.table-scroll .num-col { text-align: center; min-width: 60px; }
.table-scroll .bool-col { text-align: center; min-width: 50px; }
.check-yes { color: var(--red); font-weight: 700; }
.check-no { color: var(--green); }
.check-ok { color: var(--green); font-weight: 700; }
.check-warn { color: var(--warning); font-weight: 700; }

.accordion { border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 8px; overflow: hidden; }
.accordion-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; cursor: pointer; background: var(--surface2); transition: background .2s; }
.accordion-header:hover { background: var(--surface); }
.accordion-header .left { display: flex; align-items: center; gap: 10px; }
.accordion-body { padding: 0; max-height: 0; overflow: hidden; transition: max-height .3s, padding .3s; }
.accordion-body.open { padding: 12px 16px; max-height: 2000px; }
.chevron { transition: transform .2s; font-size: 12px; color: var(--text2); }
.chevron.open { transform: rotate(90deg); }

.spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 40px auto; }
@keyframes spin { to { transform: rotate(360deg); } }
.pulse { animation: pulse 2s infinite; }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }

.empty { text-align: center; padding: 40px; color: var(--text2); }

.issue-cat { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; }
.issue-cat-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; transition: all .2s; }
.issue-cat-card:hover { border-color: var(--accent); transform: translateY(-2px); }
.issue-cat-card .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.issue-cat-card .title { font-size: 13px; font-weight: 600; }
.issue-cat-card .desc { font-size: 12px; color: var(--text2); }

.sitemap-list { display: flex; flex-direction: column; gap: 8px; }
.sitemap-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--surface2); border-radius: var(--radius-sm); font-size: 13px; }
.sitemap-item .url { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 12px; }
.sitemap-item .meta { display: flex; gap: 8px; align-items: center; color: var(--text2); font-size: 11px; }

@media (max-width: 768px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .form-row { flex-direction: column; }
  .issue-cat { grid-template-columns: 1fr; }
}

/* Light theme */
[data-theme="light"] {
  --bg: #f0f2f5; --surface: #ffffff; --surface2: #f7f8fa;
  --border: #d9dde8; --text: #1a1d27; --text2: #5c6278;
  --accent: #6c5ce7; --accent2: #5a4bd1;
  --green: #00a89d; --red: #e74c3c; --orange: #e67e22; --blue: #2e86de;
  --critical: #e74c3c; --warning: #e67e22; --info: #2e86de;
}
[data-theme="light"] header { background: rgba(255,255,255,.85); }
[data-theme="light"] .table-scroll th { background: var(--surface); }
[data-theme="light"] ::-webkit-scrollbar-track { background: var(--bg); }
[data-theme="light"] ::-webkit-scrollbar-thumb { background: var(--border); }
[data-theme="light"] .accordion-header { background: var(--surface2); }
[data-theme="light"] .accordion-header:hover { background: #eef0f4; }
[data-theme="light"] .badge-critical { background: rgba(231,76,60,.1); }
[data-theme="light"] .badge-warning { background: rgba(230,126,34,.1); }
[data-theme="light"] .badge-info { background: rgba(46,134,222,.1); }
[data-theme="light"] .badge-good { background: rgba(0,168,157,.1); }
[data-theme="light"] .score-good { background: rgba(0,168,157,.1); }
[data-theme="light"] .score-ok { background: rgba(230,126,34,.1); }
[data-theme="light"] .score-bad { background: rgba(231,76,60,.1); }

.theme-toggle { background: var(--surface2); border: 1px solid var(--border); color: var(--text2); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all .2s; flex-shrink: 0; }
.theme-toggle:hover { border-color: var(--accent); color: var(--accent2); }

::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      SEO Crawler Pro
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <nav id="nav"></nav>
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle light/dark mode">üåô</button>
    </div>
  </div>
</header>

<div class="container" id="app"></div>

<script>
/* ‚îÄ‚îÄ Theme toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function initTheme() {
  const saved = localStorage.getItem('seo-theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  updateThemeIcon(saved);
}
function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('seo-theme', next);
  updateThemeIcon(next);
}
function updateThemeIcon(theme) {
  const btn = document.getElementById('themeToggle');
  if (btn) btn.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}
initTheme();

const API = '/api';
let state = { view: 'home', projects: [], crawl: null, summary: null, pages: [], tablePages: [], pageDetail: null, pollTimer: null, tablePage: 0 };

async function api(path, opts = {}) {
  const res = await fetch(API + path, { headers: { 'Content-Type': 'application/json' }, ...opts });
  if (!res.ok) throw new Error('API ' + res.status);
  return res.json();
}

function navigate(view, data, pushHistory) {
  if (state.pollTimer) { clearInterval(state.pollTimer); state.pollTimer = null; }
  if (data) Object.assign(state, data);
  state.view = view;
  if (pushHistory !== false) {
    history.pushState({ view: view }, '', '#' + view);
  }
  render();
}

window.addEventListener('popstate', function(e) {
  if (e.state && e.state.view) {
    state.view = e.state.view;
    render();
  } else {
    state.view = 'home';
    render();
  }
});

function render() {
  const app = document.getElementById('app');
  const nav = document.getElementById('nav');
  nav.innerHTML = '<button class="' + (state.view === 'home' ? 'active' : '') + '" onclick="navigate(\'home\')">Projects</button>';
  switch (state.view) {
    case 'home': renderHome(app); break;
    case 'crawling': renderCrawling(app); break;
    case 'dashboard': renderDashboard(app); break;
    case 'pages': renderPages(app); break;
    case 'detail': renderDetail(app); break;
  }
}

// ‚îÄ‚îÄ‚îÄ Home ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function renderHome(el) {
  el.innerHTML = '<div class="card"><h3>New Crawl</h3><div class="form-row"><input id="site-name" placeholder="Project name (e.g. My Website)"><input id="site-url" placeholder="https://example.com" value="https://"><button class="btn" onclick="startCrawl()">Crawl</button></div></div><div class="card"><h3>Recent Projects</h3><div id="projects-list"><div class="spinner"></div></div></div>';
  try {
    const projects = await api('/projects');
    const list = document.getElementById('projects-list');
    if (!projects.length) { list.innerHTML = '<div class="empty">No projects yet. Start your first crawl above.</div>'; return; }
    list.innerHTML = '<table><thead><tr><th>Name</th><th>URL</th><th>Created</th><th></th></tr></thead><tbody>' +
      projects.map(function(p) { return '<tr><td><strong>' + esc(p.name) + '</strong></td><td class="url-cell">' + esc(p.url) + '</td><td>' + new Date(p.created_at).toLocaleDateString() + '</td><td><button class="btn btn-sm" onclick="viewProject(' + p.id + ')">Crawls</button> <button class="btn btn-sm btn-outline" onclick="recrawl(' + p.id + ')">Re-crawl</button> <button class="btn btn-sm btn-danger" onclick="deleteProject(' + p.id + ')">Delete</button></td></tr>'; }).join('') +
      '</tbody></table>';
  } catch (e) { document.getElementById('projects-list').innerHTML = '<div class="empty">Error loading projects</div>'; }
}

async function startCrawl() {
  var name = document.getElementById('site-name').value.trim();
  var url = document.getElementById('site-url').value.trim();
  if (!name || !url || url === 'https://') return alert('Enter project name and URL');
  try {
    var project = await api('/projects', { method: 'POST', body: JSON.stringify({ name: name, url: url }) });
    var crawl = await api('/crawls', { method: 'POST', body: JSON.stringify({ project_id: project.id }) });
    navigate('crawling', { crawl: crawl });
    pollCrawl(crawl.id);
  } catch (e) { alert('Error: ' + e.message); }
}

async function recrawl(projectId) {
  try {
    var crawl = await api('/crawls', { method: 'POST', body: JSON.stringify({ project_id: projectId }) });
    navigate('crawling', { crawl: crawl });
    pollCrawl(crawl.id);
  } catch (e) { alert('Error: ' + e.message); }
}

async function viewProject(projectId) {
  try {
    var crawls = await api('/projects/' + projectId + '/crawls');
    if (crawls.length === 0) return alert('No crawls yet');
    var latest = crawls[0];
    if (latest.status === 'completed') {
      var results = await Promise.all([api('/crawls/' + latest.id + '/summary'), api('/crawls/' + latest.id + '/pages'), api('/crawls/' + latest.id + '/pages/table')]);
      navigate('dashboard', { crawl: latest, summary: results[0], pages: results[1], tablePages: results[2] });
    } else if (latest.status === 'running' || latest.status === 'pending' || latest.status === 'paused') {
      navigate('crawling', { crawl: latest });
      pollCrawl(latest.id);
    } else if (latest.status === 'stopped') {
      // Show stopped state with resume option
      navigate('crawling', { crawl: latest });
    } else { alert('Last crawl failed. Try re-crawling.'); }
  } catch (e) { alert('Error: ' + e.message); }
}

async function deleteProject(id) {
  if (!confirm('Delete this project and all its crawls?')) return;
  await api('/projects/' + id, { method: 'DELETE' });
  navigate('home');
}

// ‚îÄ‚îÄ‚îÄ Crawling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCrawling(el) {
  var c = state.crawl;
  var isRunning = c.status === 'running' || c.status === 'pending';
  var isPaused = c.status === 'paused';
  var isStopped = c.status === 'stopped';

  var html = '<div class="card" style="text-align:center;padding:40px;">';

  if (isRunning) {
    html += '<div class="spinner"></div>';
    html += '<h2 style="margin-top:20px" class="pulse">Crawling website...</h2>';
  } else if (isPaused) {
    html += '<div style="font-size:48px;margin-bottom:12px;">&#9208;</div>';
    html += '<h2 style="margin-top:8px;color:var(--orange);">Crawl Paused</h2>';
  } else if (isStopped) {
    html += '<div style="font-size:48px;margin-bottom:12px;">&#9209;</div>';
    html += '<h2 style="margin-top:8px;color:var(--red);">Crawl Stopped</h2>';
  }

  html += '<p style="color:var(--text2);margin-top:8px;">Status: <strong id="crawl-status">' + c.status + '</strong></p>';
  html += '<p style="color:var(--text2);">Pages crawled: <strong id="crawl-count">' + c.pages_crawled + '</strong></p>';
  html += '<div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">';

  if (isRunning) {
    html += '<button class="btn" onclick="pauseCrawl()" style="background:var(--orange);">&#9208; Pause</button>';
    html += '<button class="btn btn-danger" onclick="stopCrawl()">&#9209; Stop</button>';
  } else if (isPaused) {
    html += '<button class="btn" onclick="resumeCrawl()">&#9654; Resume</button>';
    html += '<button class="btn btn-danger" onclick="stopCrawl()">&#9209; Stop</button>';
  } else if (isStopped) {
    html += '<button class="btn" onclick="resumeCrawl()">&#9654; Resume Crawl</button>';
    html += '<button class="btn btn-outline" onclick="navigate(\'home\')">Back to Projects</button>';
    // If pages were crawled, allow viewing partial results
    if (c.pages_crawled > 0) {
      html += '<button class="btn btn-sm btn-outline" onclick="viewPartialResults(' + c.id + ')">View Partial Results</button>';
    }
  }

  html += '</div></div>';
  el.innerHTML = html;
}

async function pauseCrawl() {
  if (!state.crawl) return;
  try {
    await api('/crawls/' + state.crawl.id + '/pause', { method: 'POST' });
    state.crawl.status = 'paused';
    render();
  } catch (e) { alert('Error: ' + e.message); }
}

async function resumeCrawl() {
  if (!state.crawl) return;
  try {
    await api('/crawls/' + state.crawl.id + '/resume', { method: 'POST' });
    state.crawl.status = 'running';
    render();
    pollCrawl(state.crawl.id);
  } catch (e) { alert('Error: ' + e.message); }
}

async function stopCrawl() {
  if (!state.crawl) return;
  if (!confirm('Stop the crawl? You can resume it later.')) return;
  try {
    await api('/crawls/' + state.crawl.id + '/stop', { method: 'POST' });
    state.crawl.status = 'stopped';
    if (state.pollTimer) { clearInterval(state.pollTimer); state.pollTimer = null; }
    render();
  } catch (e) { alert('Error: ' + e.message); }
}

async function viewPartialResults(crawlId) {
  try {
    var results = await Promise.all([api('/crawls/' + crawlId + '/summary'), api('/crawls/' + crawlId + '/pages'), api('/crawls/' + crawlId + '/pages/table')]);
    navigate('dashboard', { summary: results[0], pages: results[1], tablePages: results[2] });
  } catch (e) { alert('Error loading results: ' + e.message); }
}

function pollCrawl(crawlId) {
  if (state.pollTimer) { clearInterval(state.pollTimer); state.pollTimer = null; }
  state.pollTimer = setInterval(async function() {
    try {
      var c = await api('/crawls/' + crawlId);
      var prevStatus = state.crawl ? state.crawl.status : null;
      state.crawl = c;
      // Update live counters without full re-render
      var el = document.getElementById('crawl-count');
      if (el) el.textContent = c.pages_crawled;
      var statusEl = document.getElementById('crawl-status');
      if (statusEl) statusEl.textContent = c.status;

      if (c.status === 'completed') {
        clearInterval(state.pollTimer); state.pollTimer = null;
        var results = await Promise.all([api('/crawls/' + c.id + '/summary'), api('/crawls/' + c.id + '/pages'), api('/crawls/' + c.id + '/pages/table')]);
        navigate('dashboard', { crawl: c, summary: results[0], pages: results[1], tablePages: results[2] });
      } else if (c.status === 'failed') {
        clearInterval(state.pollTimer); state.pollTimer = null;
        alert('Crawl failed.'); navigate('home');
      } else if (c.status === 'stopped') {
        clearInterval(state.pollTimer); state.pollTimer = null;
        renderCrawling(document.getElementById('app'));
      } else if (c.status === 'paused' && prevStatus !== 'paused') {
        // Status just changed to paused ‚Äî re-render to show pause UI
        renderCrawling(document.getElementById('app'));
      } else if (c.status === 'running' && prevStatus === 'paused') {
        // Resumed ‚Äî re-render to show running UI
        renderCrawling(document.getElementById('app'));
      }
    } catch (e) { console.error(e); }
  }, 2000);
}

// ‚îÄ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderDashboard(el) {
  var s = state.summary;
  var scoreClass = s.avg_score >= 70 ? 'score-good' : s.avg_score >= 40 ? 'score-ok' : 'score-bad';
  var PER_PAGE = 50;
  var allTP = state.tablePages || [];
  var totalTablePages = Math.ceil(allTP.length / PER_PAGE) || 1;
  if (state.tablePage >= totalTablePages) state.tablePage = totalTablePages - 1;
  if (state.tablePage < 0) state.tablePage = 0;
  var pageSlice = allTP.slice(state.tablePage * PER_PAGE, (state.tablePage + 1) * PER_PAGE);

  var html = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;"><h2>Crawl Dashboard</h2><div style="display:flex;gap:8px;"><button class="btn btn-sm" onclick="exportPDF()">&#128196; PDF</button><button class="btn btn-sm" onclick="exportExcel()" style="background:var(--green);">&#128202; Excel</button><button class="btn btn-sm btn-outline" onclick="navigate(\'pages\')">All Pages</button><button class="btn btn-sm btn-outline" onclick="navigate(\'home\')">Back</button></div></div>';

  // ‚îÄ‚îÄ Scorecards ‚îÄ‚îÄ
  html += '<div class="stats-grid">';
  html += '<div class="stat-card"><div class="score-ring ' + scoreClass + '">' + s.avg_score + '</div><div class="label">Avg Score</div></div>';
  html += '<div class="stat-card"><div class="value">' + s.total_pages + '</div><div class="label">Pages Crawled</div></div>';
  html += '<div class="stat-card critical"><div class="value">' + s.critical_issues + '</div><div class="label">Critical Issues</div></div>';
  html += '<div class="stat-card warning"><div class="value">' + s.warnings + '</div><div class="label">Warnings</div></div>';
  html += '<div class="stat-card info"><div class="value">' + (s.info_issues || 0) + '</div><div class="label">Info</div></div>';
  html += '<div class="stat-card"><div class="value">' + s.avg_response_time + 's</div><div class="label">Avg Response</div></div>';
  html += '</div>';

  // ‚îÄ‚îÄ Status Code Pie Chart ‚îÄ‚îÄ
  var scb = s.status_code_breakdown || [];
  if (scb.length) {
    var groups = {'2xx':0,'3xx':0,'4xx':0,'5xx':0};
    scb.forEach(function(c){
      var code = c.status_code;
      if (code>=200 && code<300) groups['2xx'] += c.count;
      else if (code>=300 && code<400) groups['3xx'] += c.count;
      else if (code>=400 && code<500) groups['4xx'] += c.count;
      else if (code>=500) groups['5xx'] += c.count;
    });
    var totalSC = groups['2xx']+groups['3xx']+groups['4xx']+groups['5xx'];
    var pieColors = {'2xx':'#00cec9','3xx':'#a29bfe','4xx':'#fdcb6e','5xx':'#ff6b6b'};
    var pieData = [];
    ['2xx','3xx','4xx','5xx'].forEach(function(k){if(groups[k]>0) pieData.push({label:k,value:groups[k],color:pieColors[k]});});
    // Build SVG pie
    var svgPie = '<svg viewBox="0 0 36 36" style="width:140px;height:140px;transform:rotate(-90deg);">';
    var cumulative = 0;
    pieData.forEach(function(d){
      var pct = (d.value / totalSC) * 100;
      var dashArray = pct + ' ' + (100 - pct);
      svgPie += '<circle cx="18" cy="18" r="15.915" fill="none" stroke="'+d.color+'" stroke-width="3.5" stroke-dasharray="'+dashArray+'" stroke-dashoffset="-'+cumulative+'" />';
      cumulative += pct;
    });
    svgPie += '</svg>';
    var legend = '';
    pieData.forEach(function(d){
      var pct = ((d.value/totalSC)*100).toFixed(1);
      legend += '<div style="display:flex;align-items:center;gap:6px;font-size:13px;"><span style="width:12px;height:12px;border-radius:3px;background:'+d.color+';display:inline-block;"></span><span style="color:var(--text);">'+d.label+': <strong>'+d.value+'</strong> ('+pct+'%)</span></div>';
    });
    html += '<div class="card"><h3>Status Codes Overview</h3><div style="display:flex;align-items:center;gap:32px;flex-wrap:wrap;"><div style="flex-shrink:0;">'+svgPie+'</div><div style="display:flex;flex-direction:column;gap:6px;">'+legend+'</div></div></div>';
  }

  // ‚îÄ‚îÄ All URLs Table (paginated 50/page) ‚îÄ‚îÄ
  html += '<div class="card" id="sec-all-urls"><h3>All URLs <span class="badge badge-info">' + allTP.length + ' pages</span></h3>';
  // Pagination controls top
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">';
  html += '<span style="font-size:13px;color:var(--text2);">Page ' + (state.tablePage + 1) + ' of ' + totalTablePages + ' (' + allTP.length + ' URLs)</span>';
  html += '<div style="display:flex;gap:6px;">';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(0)" ' + (state.tablePage === 0 ? 'disabled' : '') + '>&laquo; First</button>';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (state.tablePage - 1) + ')" ' + (state.tablePage === 0 ? 'disabled' : '') + '>&lsaquo; Prev</button>';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (state.tablePage + 1) + ')" ' + (state.tablePage >= totalTablePages - 1 ? 'disabled' : '') + '>Next &rsaquo;</button>';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (totalTablePages - 1) + ')" ' + (state.tablePage >= totalTablePages - 1 ? 'disabled' : '') + '>Last &raquo;</button>';
  html += '</div></div>';
  html += '<div class="table-scroll"><table><thead><tr>';
  html += '<th class="url-col">URL</th><th class="num-col">Status</th><th class="num-col">Score</th><th class="num-col">Title Len</th><th class="num-col">Meta Len</th>';
  html += '<th class="num-col">H1s</th><th class="num-col">H2s</th><th class="bool-col">Noindex</th><th class="bool-col">Nofollow</th>';
  html += '<th class="num-col">Images</th><th class="num-col">No Alt</th><th class="num-col">Empty Alt</th>';
  html += '<th class="num-col">Int Links</th><th class="num-col">Ext Links</th><th class="num-col">NF Links</th>';
  html += '<th class="num-col">Words</th><th class="num-col">Text%</th>';
  html += '<th class="bool-col">Schema</th><th class="bool-col">Hreflang</th><th class="bool-col">Viewport</th><th class="bool-col">Lazy</th><th class="bool-col">Placeh.</th>';
  html += '<th class="num-col">Time</th><th class="num-col">Issues</th>';
  html += '</tr></thead><tbody>';
  pageSlice.forEach(function(p) {
    var stc = statusBadge(p.status_code);
    var sc = (p.score || 0) >= 70 ? 'badge-good' : (p.score || 0) >= 40 ? 'badge-warning' : 'badge-critical';
    var tl = p.title_length || 0;
    var tlc = (tl >= 30 && tl <= 60) ? 'check-ok' : tl === 0 ? 'check-yes' : 'check-warn';
    var ml = p.meta_description_length || 0;
    var mlc = (ml >= 120 && ml <= 160) ? 'check-ok' : ml === 0 ? 'check-yes' : 'check-warn';
    var h1c = p.h1_count === 1 ? 'check-ok' : p.h1_count === 0 ? 'check-yes' : 'check-warn';
    var wc = (p.word_count || 0) >= 300 ? '' : 'check-warn';
    var rt = p.response_time ? p.response_time.toFixed(2) : '?';
    var rtc = p.response_time && p.response_time > 3 ? 'check-warn' : '';
    html += '<tr>';
    html += '<td class="url-col"><a href="#" onclick="loadPage(' + p.id + ');return false" title="' + esc(p.url) + '">' + esc(p.url) + '</a></td>';
    html += '<td class="num-col"><span class="badge ' + stc + '">' + (p.status_code || '?') + '</span></td>';
    html += '<td class="num-col"><span class="badge ' + sc + '">' + (p.score || '?') + '</span></td>';
    html += '<td class="num-col ' + tlc + '">' + tl + '</td>';
    html += '<td class="num-col ' + mlc + '">' + ml + '</td>';
    html += '<td class="num-col ' + h1c + '">' + (p.h1_count || 0) + '</td>';
    html += '<td class="num-col">' + (p.h2_count || 0) + '</td>';
    html += '<td class="bool-col">' + (p.is_noindex ? '<span class="check-yes">YES</span>' : '<span class="check-no">‚Äî</span>') + '</td>';
    html += '<td class="bool-col">' + (p.is_nofollow_meta ? '<span class="check-yes">YES</span>' : '<span class="check-no">‚Äî</span>') + '</td>';
    html += '<td class="num-col">' + (p.total_images || 0) + '</td>';
    html += '<td class="num-col">' + (p.images_without_alt ? '<span class="check-warn">' + p.images_without_alt + '</span>' : '0') + '</td>';
    html += '<td class="num-col">' + (p.images_with_empty_alt ? '<span class="check-warn">' + p.images_with_empty_alt + '</span>' : '0') + '</td>';
    html += '<td class="num-col">' + (p.internal_links || 0) + '</td>';
    html += '<td class="num-col">' + (p.external_links || 0) + '</td>';
    html += '<td class="num-col">' + (p.nofollow_links || 0) + '</td>';
    html += '<td class="num-col ' + wc + '">' + (p.word_count || 0) + '</td>';
    html += '<td class="num-col">' + (p.code_to_text_ratio != null ? p.code_to_text_ratio + '%' : '?') + '</td>';
    html += '<td class="bool-col">' + (p.has_schema_markup ? '<span class="check-ok">&#10003;</span>' : '<span class="check-warn">&#10007;</span>') + '</td>';
    html += '<td class="bool-col">' + (p.has_hreflang ? '<span class="check-ok">&#10003;</span>' : '‚Äî') + '</td>';
    html += '<td class="bool-col">' + (p.has_viewport_meta ? '<span class="check-ok">&#10003;</span>' : '<span class="check-yes">&#10007;</span>') + '</td>';
    html += '<td class="bool-col">' + (p.has_lazy_loading ? '<span class="check-ok">&#10003;</span>' : '‚Äî') + '</td>';
    html += '<td class="bool-col">' + (p.has_placeholders ? '<span class="check-yes">YES</span>' : '‚Äî') + '</td>';
    html += '<td class="num-col ' + rtc + '">' + rt + 's</td>';
    html += '<td class="num-col">' + (p.issues_count || 0) + '</td>';
    html += '</tr>';
  });
  html += '</tbody></table></div>';
  // Pagination controls bottom
  html += '<div style="display:flex;align-items:center;justify-content:center;margin-top:10px;gap:6px;">';
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (state.tablePage - 1) + ')" ' + (state.tablePage === 0 ? 'disabled' : '') + '>&lsaquo; Prev</button>';
  for (var pi = 0; pi < totalTablePages; pi++) {
    if (totalTablePages <= 10 || pi === 0 || pi === totalTablePages - 1 || Math.abs(pi - state.tablePage) <= 2) {
      html += '<button class="btn btn-sm ' + (pi === state.tablePage ? '' : 'btn-outline') + '" onclick="goTablePage(' + pi + ')" style="min-width:32px;">' + (pi + 1) + '</button>';
    } else if (pi === 1 || pi === totalTablePages - 2) {
      html += '<span style="color:var(--text2);padding:0 4px;">...</span>';
    }
  }
  html += '<button class="btn btn-sm btn-outline" onclick="goTablePage(' + (state.tablePage + 1) + ')" ' + (state.tablePage >= totalTablePages - 1 ? 'disabled' : '') + '>Next &rsaquo;</button>';
  html += '</div></div>';

  // ‚îÄ‚îÄ All Issues ‚Äî rendered dynamically from issue_groups ‚îÄ‚îÄ
  html += '<div class="card"><h3>Issues</h3>';

  // Human-readable names for issue categories
  var issueNames = {
    'missing_title': 'Missing Title Tag', 'missing_meta_description': 'Missing Meta Description',
    'missing_h1': 'Missing H1 Tag', 'missing_viewport': 'Missing Viewport Meta',
    'placeholder_content': 'Placeholder / Lorem Ipsum Content', 'http_error': 'HTTP Errors (4xx/5xx)',
    'short_title': 'Short Title Tag', 'long_title': 'Long Title Tag',
    'short_meta_description': 'Short Meta Description', 'long_meta_description': 'Long Meta Description',
    'missing_canonical': 'Missing Canonical Tag', 'canonical_external': 'Canonical Points to External URL',
    'canonical_mismatch': 'Canonical URL Mismatch', 'canonical_relative': 'Relative Canonical URL',
    'images_missing_alt': 'Images Missing Alt Attribute', 'images_empty_alt': 'Images With Empty Alt',
    'thin_content': 'Thin Content (<300 words)', 'low_text_ratio': 'Low Text-to-HTML Ratio',
    'high_text_ratio': 'High Text-to-HTML Ratio', 'multiple_h1': 'Multiple H1 Tags',
    'noindex': 'Noindex Pages', 'nofollow_meta': 'Nofollow Meta Pages',
    'nofollow_internal': 'Internal Nofollow Links', 'hreflang_issue': 'Hreflang Issues',
    'slow_response': 'Slow Pages (>3s)', 'redirect': 'Redirect Pages',
    'no_schema_markup': 'No Schema Markup', 'no_lazy_loading': 'No Lazy Loading',
    'missing_og_title': 'Missing OG Title', 'missing_og_description': 'Missing OG Description',
    'missing_og_image': 'Missing OG Image',
  };

  function issueAcc(id, sev, title, count, bodyHtml) {
    if (!count) return;
    html += '<div class="accordion" id="' + id + '"><div class="accordion-header" onclick="toggleAcc(this)"><div class="left"><span class="badge badge-' + sev + '">' + sev + '</span><span style="font-size:13px;">' + title + '</span></div><div style="display:flex;align-items:center;gap:8px;"><span class="badge badge-' + sev + '">' + count + '</span><span class="chevron">&#9654;</span></div></div>';
    html += '<div class="accordion-body">' + bodyHtml + '</div></div>';
  }

  // Render ALL issue_groups dynamically (sorted by severity then count)
  var groups = (s.issue_groups || []).slice();
  groups.forEach(function(g) {
    var title = issueNames[g.category] || fmtType(g.category);
    var b = '<table><thead><tr><th>URL</th><th>Detail</th></tr></thead><tbody>';
    (g.pages || []).forEach(function(p) {
      b += '<tr><td class="url-cell"><a href="#" onclick="loadPage('+p.page_id+');return false">'+esc(p.url)+'</a></td><td style="font-size:12px;max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+esc(p.detail||'')+'</td></tr>';
    });
    b += '</tbody></table>';
    issueAcc('sec-ig-'+g.category, g.severity, title, g.count, b);
  });

  // Duplicate Titles (special rendering ‚Äî groups, not flat list)
  if (s.duplicate_titles.length) {
    var b = '';
    s.duplicate_titles.forEach(function(g) {
      b += '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:var(--text);">"'+esc(g.value.substring(0,80))+(g.value.length>80?'...':'')+'" ('+g.count+'x)</strong><div style="margin-left:12px;">';
      g.pages.forEach(function(p){b+='<div style="font-size:12px;"><a href="#" onclick="loadPage('+p.page_id+');return false">'+esc(p.url)+'</a></div>';});
      b += '</div></div>';
    });
    issueAcc('sec-dup-titles','warning','Duplicate Title Tags',s.duplicate_titles.length+' groups',b);
  }

  // Duplicate Meta Descriptions (special rendering ‚Äî groups)
  if (s.duplicate_meta_descriptions.length) {
    var b = '';
    s.duplicate_meta_descriptions.forEach(function(g) {
      b += '<div style="margin-bottom:8px;"><strong style="font-size:12px;color:var(--text);">"'+esc(g.value.substring(0,80))+(g.value.length>80?'...':'')+'" ('+g.count+'x)</strong><div style="margin-left:12px;">';
      g.pages.forEach(function(p){b+='<div style="font-size:12px;"><a href="#" onclick="loadPage('+p.page_id+');return false">'+esc(p.url)+'</a></div>';});
      b += '</div></div>';
    });
    issueAcc('sec-dup-metas','warning','Duplicate Meta Descriptions',s.duplicate_meta_descriptions.length+' groups',b);
  }

  // Canonical Issues (special ‚Äî shows canonical URL + issues)
  if (s.canonical_issues.length) {
    var b = '<table><thead><tr><th>Page URL</th><th>Canonical URL</th><th>Issues</th></tr></thead><tbody>';
    s.canonical_issues.forEach(function(c) {
      b += '<tr><td class="url-cell"><a href="#" onclick="loadPage('+c.page_id+');return false">'+esc(c.url)+'</a></td><td class="url-cell">'+esc(c.canonical_url||'none')+'</td><td>'+(c.issues||[]).map(function(i){return '<span class="badge badge-warning">'+i+'</span> ';}).join('')+'</td></tr>';
    });
    b += '</tbody></table>';
    issueAcc('sec-canonical','warning','Canonical Tag Issues (detailed)',s.canonical_issues.length,b);
  }

  // Images Missing Alt (special ‚Äî shows counts)
  if (s.pages_missing_alt.length) {
    var b = '<table><thead><tr><th>Page URL</th><th>Missing</th><th>Total</th></tr></thead><tbody>';
    s.pages_missing_alt.forEach(function(p) {
      b += '<tr><td class="url-cell"><a href="#" onclick="loadPage('+p.page_id+');return false">'+esc(p.url)+'</a></td><td><span class="badge badge-warning">'+p.missing_count+'</span></td><td>'+p.total_images+'</td></tr>';
    });
    b += '</tbody></table>';
    issueAcc('sec-img-detail','warning','Images Missing Alt (detailed)',s.total_images_missing_alt+' images on '+s.pages_missing_alt.length+' pages',b);
  }

  // Status Code Breakdown
  var statusBody = '<div style="display:flex;gap:12px;flex-wrap:wrap;">';
  (s.status_code_breakdown || []).forEach(function(c) {
    var badge = statusBadge(c.status_code);
    var color = badge.replace('badge-', '');
    statusBody += '<div class="stat-card ' + color + '" style="min-width:100px;flex:0;"><div class="value">' + c.count + '</div><div class="label">HTTP ' + c.status_code + '</div></div>';
  });
  statusBody += '</div>';
  if (s.status_code_breakdown && s.status_code_breakdown.length) {
    issueAcc('sec-status','info','Status Code Breakdown',s.status_code_breakdown.map(function(c){return c.count;}).reduce(function(a,b){return a+b;},0)+' pages',statusBody);
  }

  // Robots & Sitemaps
  var robotsBody = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">';
  robotsBody += '<div><h4 style="margin-bottom:8px;font-size:12px;">robots.txt</h4><div class="sitemap-item"><span>Status</span><span class="badge '+(s.robots_txt_status==='found'?'badge-good':'badge-critical')+'">'+(s.robots_txt_status||'unknown')+'</span></div></div>';
  robotsBody += '<div><h4 style="margin-bottom:8px;font-size:12px;">Sitemaps</h4><div class="sitemap-list">';
  if (s.sitemaps_found && s.sitemaps_found.length) {
    s.sitemaps_found.forEach(function(sm){
      robotsBody += '<div class="sitemap-item"><span class="url">'+esc(sm.url)+'</span><span class="meta"><span class="badge badge-info">'+sm.type+'</span><span>'+(sm.urls_count||0)+' URLs</span></span></div>';
    });
  } else { robotsBody += '<div style="color:var(--text2);font-size:12px;">No sitemaps detected</div>'; }
  robotsBody += '</div></div></div>';
  issueAcc('sec-robots','info','Robots.txt & Sitemaps',(s.sitemaps_found?s.sitemaps_found.length:0)+' sitemaps',robotsBody);

  html += '</div>'; // close Issues card

  el.innerHTML = html;
}

function goTablePage(pg) {
  var allTP = state.tablePages || [];
  var totalTablePages = Math.ceil(allTP.length / 50) || 1;
  if (pg < 0) pg = 0;
  if (pg >= totalTablePages) pg = totalTablePages - 1;
  state.tablePage = pg;
  render();
  var el = document.getElementById('sec-all-urls');
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderAccordionGroups(groups) {
  var html = '';
  groups.forEach(function(g) {
    html += '<div class="accordion"><div class="accordion-header" onclick="toggleAcc(this)"><div class="left"><span class="badge badge-warning">' + g.count + 'x</span><span style="font-size:13px;">' + esc(g.value.substring(0, 80)) + (g.value.length > 80 ? '...' : '') + '</span></div><span class="chevron">&#9654;</span></div>';
    html += '<div class="accordion-body"><table><thead><tr><th>URL</th></tr></thead><tbody>';
    g.pages.forEach(function(p) { html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.page_id + ');return false">' + esc(p.url) + '</a></td></tr>'; });
    html += '</tbody></table></div></div>';
  });
  return html;
}

function toggleAcc(header) {
  var body = header.nextElementSibling;
  var chev = header.querySelector('.chevron');
  body.classList.toggle('open');
  chev.classList.toggle('open');
}

function fmtType(type) { return type.replace(/_/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); }); }

function scrollToSec(id) {
  var el = document.getElementById(id);
  if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function statusBadge(code) {
  if (!code) return 'badge-critical';
  if (code >= 200 && code < 300) return 'badge-2xx';
  if (code >= 300 && code < 400) return 'badge-3xx';
  if (code >= 400 && code < 500) return 'badge-4xx';
  if (code >= 500) return 'badge-5xx';
  return 'badge-info';
}

function exportPDF() {
  if (!state.crawl) return;
  var url = API + '/crawls/' + state.crawl.id + '/export/pdf';
  window.open(url, '_blank');
}

function exportExcel() {
  if (!state.crawl) return;
  var url = API + '/crawls/' + state.crawl.id + '/export/excel';
  window.open(url, '_blank');
}

// ‚îÄ‚îÄ‚îÄ Pages List ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPages(el) {
  var pages = state.pages;
  var html = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;"><h2>All Pages (' + pages.length + ')</h2><button class="btn btn-sm btn-outline" onclick="navigate(\'dashboard\')">Back to Dashboard</button></div>';
  html += '<div class="card"><table><thead><tr><th>URL</th><th>Status</th><th>Score</th><th>Issues</th><th>Response</th><th></th></tr></thead><tbody>';
  pages.forEach(function(p) {
    var sc = (p.score || 0) >= 70 ? 'badge-good' : (p.score || 0) >= 40 ? 'badge-warning' : 'badge-critical';
    var stc = (p.status_code || 0) < 300 ? 'badge-good' : (p.status_code || 0) < 400 ? 'badge-info' : 'badge-critical';
    html += '<tr><td class="url-cell"><a href="#" onclick="loadPage(' + p.id + ');return false">' + esc(p.url) + '</a></td><td><span class="badge ' + stc + '">' + (p.status_code || '?') + '</span></td><td><span class="badge ' + sc + '">' + (p.score || '?') + '</span></td><td>' + p.issues_count + '</td><td>' + (p.response_time ? p.response_time.toFixed(2) + 's' : '?') + '</td><td><button class="btn btn-sm btn-outline" onclick="loadPage(' + p.id + ')">Details</button></td></tr>';
  });
  html += '</tbody></table></div>';
  el.innerHTML = html;
}

// ‚îÄ‚îÄ‚îÄ Page Detail ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadPage(pageId) {
  try {
    var page = await api('/pages/' + pageId);
    navigate('detail', { pageDetail: page });
  } catch (e) { alert('Error: ' + e.message); }
}

function renderDetail(el) {
  var p = state.pageDetail;
  if (!p) return;
  var sc = (p.score || 0) >= 70 ? 'score-good' : (p.score || 0) >= 40 ? 'score-ok' : 'score-bad';
  var html = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;"><h2 style="font-size:16px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;">' + esc(p.url) + '</h2><button class="btn btn-sm btn-outline" onclick="history.back()">Back</button></div>';

  html += '<div class="stats-grid">';
  html += '<div class="stat-card"><div class="score-ring ' + sc + '">' + (p.score || '?') + '</div><div class="label">Score</div></div>';
  html += '<div class="stat-card"><div class="value">' + (p.status_code || '?') + '</div><div class="label">Status</div></div>';
  html += '<div class="stat-card"><div class="value">' + (p.response_time ? p.response_time.toFixed(2) + 's' : '?') + '</div><div class="label">Response</div></div>';
  html += '<div class="stat-card"><div class="value">' + (p.word_count || 0) + '</div><div class="label">Words</div></div>';
  html += '<div class="stat-card"><div class="value">' + (p.code_to_text_ratio != null ? p.code_to_text_ratio + '%' : '?') + '</div><div class="label">Text/HTML</div></div>';
  html += '</div>';

  // Issues
  html += '<div class="card"><h3>Issues (' + (p.issues || []).length + ')</h3>';
  if ((p.issues || []).length) {
    html += '<table><thead><tr><th>Severity</th><th>Type</th><th>Message</th></tr></thead><tbody>';
    (p.issues || []).forEach(function(i) { html += '<tr><td><span class="badge badge-' + i.severity + '">' + i.severity + '</span></td><td style="font-size:12px;">' + fmtType(i.type) + '</td><td style="font-size:12px;">' + esc(i.message) + '</td></tr>'; });
    html += '</tbody></table>';
  } else { html += '<div style="color:var(--green);padding:12px;">No issues found!</div>'; }
  html += '</div>';

  // SEO Details
  html += '<div class="card"><h3>On-Page SEO</h3><table><tbody>';
  html += dRow('Title', p.title, p.title_length ? '(' + p.title_length + ' chars)' : '');
  html += dRow('Meta Description', p.meta_description ? p.meta_description.substring(0, 120) + '...' : null, p.meta_description_length ? '(' + p.meta_description_length + ' chars)' : '');
  html += dRow('Canonical URL', p.canonical_url);
  if (p.canonical_issues && p.canonical_issues.length) html += dRow('Canonical Issues', p.canonical_issues.join(', '));
  html += dRow('Robots Meta', p.robots_meta);
  html += dRow('Noindex', p.is_noindex ? 'Yes' : 'No');
  html += dRow('Nofollow Meta', p.is_nofollow_meta ? 'Yes' : 'No');
  html += dRow('H1', p.h1_texts ? p.h1_texts.join(', ') : 'None', '(' + p.h1_count + ' found)');
  html += dRow('H2-H6', 'H2:' + p.h2_count + ' H3:' + p.h3_count + ' H4:' + (p.h4_count || 0) + ' H5:' + (p.h5_count || 0) + ' H6:' + (p.h6_count || 0));
  html += dRow('Viewport', p.has_viewport_meta ? 'Present' : 'Missing');
  html += '</tbody></table></div>';

  // Links & Images
  html += '<div class="card"><h3>Links & Images</h3><table><tbody>';
  html += dRow('Internal Links', p.internal_links);
  html += dRow('External Links', p.external_links);
  html += dRow('Nofollow Links', p.nofollow_links || 0);
  html += dRow('Total Images', p.total_images);
  html += dRow('Images Without Alt', p.images_without_alt);
  html += dRow('Images Empty Alt', p.images_with_empty_alt || 0);
  html += '</tbody></table></div>';

  // Structured Data & Social
  html += '<div class="card"><h3>Structured Data & Social</h3><table><tbody>';
  html += dRow('Schema Markup', p.has_schema_markup ? 'Yes' : 'No');
  html += dRow('Schema Types', p.schema_types ? p.schema_types.join(', ') : 'None');
  html += dRow('OG Title', p.og_title);
  html += dRow('OG Description', p.og_description ? p.og_description.substring(0, 100) + '...' : null);
  html += dRow('OG Image', p.og_image);
  html += dRow('Hreflang', p.has_hreflang ? 'Yes (' + (p.hreflang_entries || []).length + ' entries)' : 'No');
  html += dRow('Placeholders', p.has_placeholders ? 'Yes (' + (p.placeholder_content || []).length + ')' : 'No');
  html += dRow('Lazy Loading', p.has_lazy_loading ? 'Yes' : 'No');
  html += '</tbody></table></div>';

  el.innerHTML = html;
}

function dRow(label, value, extra) {
  var display = value || '<span style="color:var(--text2)">‚Äî</span>';
  return '<tr><td style="color:var(--text2);width:200px;font-size:13px;">' + label + '</td><td style="font-size:13px;">' + esc(String(display)) + ' <span style="color:var(--text2);font-size:11px;">' + (extra || '') + '</span></td></tr>';
}

function esc(str) {
  if (!str) return '';
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

history.replaceState({ view: 'home' }, '', '#home');
render();
</script>
</body>
</html>
